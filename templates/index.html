<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>xlsm データビューア</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: "Segoe UI", "Meiryo", sans-serif; background: #f5f7fa; color: #333; padding: 20px; }
  h1 { margin-bottom: 20px; font-size: 1.4rem; }
  .panel { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .panel h2 { font-size: 1.1rem; margin-bottom: 12px; color: #555; }
  label { font-weight: 600; margin-right: 6px; }
  input[type="text"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem; width: 200px; }
  button { padding: 6px 16px; border: none; border-radius: 4px; background: #4a90d9; color: #fff; font-size: 0.95rem; cursor: pointer; margin-left: 8px; }
  button:hover { background: #357abd; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; white-space: nowrap; }
  th { background: #e8ecf1; position: sticky; top: 0; }
  .table-wrap { max-height: 500px; overflow: auto; }
  .error { color: #d9534f; }
  .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .count { margin-top: 8px; font-size: 0.9rem; color: #555; }
</style>
</head>
<body>

<div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
  <h1 style="margin-bottom:0;">xlsm データビューア</h1>
  <button id="btn-refresh" style="background:#27ae60;">&#x21bb; 最新データ取得</button>
  <span id="refresh-status" style="font-size:0.85rem; color:#888;"></span>
</div>
<div id="file-info" style="margin-bottom:16px; padding:10px 14px; background:#e8ecf1; border-radius:6px; font-size:0.85rem; color:#555;"></div>

<div id="search-panels"></div>

<script>
// ファイル情報取得
fetch("/api/fileinfo")
  .then(r => r.json())
  .then(info => {
    const el = document.getElementById("file-info");
    if (info.source === "onedrive") {
      el.innerHTML = `<b>ソース:</b> OneDrive | <b>ファイル名:</b> ${info.filename || "不明"} | <b>取得日時:</b> ${info.fetched_at || "未取得"} | <b>サイズ:</b> ${info.content_length ? (info.content_length / 1024 / 1024).toFixed(1) + " MB" : "不明"}`;
    } else {
      el.innerHTML = `<b>ソース:</b> ローカル | <b>ファイル名:</b> ${info.filename || "不明"} | <b>最終更新:</b> ${info.last_modified || "不明"}`;
    }
  })
  .catch(() => {});

// 更新ボタン
document.getElementById("btn-refresh").addEventListener("click", () => {
  const status = document.getElementById("refresh-status");
  const btn = document.getElementById("btn-refresh");
  btn.disabled = true;
  status.textContent = "更新中...";
  fetch("/api/refresh", { method: "POST" })
    .then(r => r.json())
    .then(data => {
      status.textContent = `更新完了！（${data.elapsed_s}秒）`;
      setTimeout(() => { status.textContent = ""; }, 5000);
    })
    .catch(e => { status.textContent = "更新失敗: " + e; })
    .finally(() => { btn.disabled = false; });
});

// シート一覧を取得して検索パネルを動的生成
fetch("/api/sheets")
  .then(r => r.json())
  .then(sheets => {
    const container = document.getElementById("search-panels");
    sheets.forEach((sheet, idx) => {
      const panelId = `panel-${idx}`;
      const inputId = `input-${idx}`;
      const btnId = `btn-${idx}`;
      const countId = `count-${idx}`;
      const resultId = `result-${idx}`;

      const div = document.createElement("div");
      div.className = "panel";
      div.innerHTML = `
        <h2>${sheet.name} — ${sheet.search_label}検索</h2>
        <div class="controls">
          <label>${sheet.search_label}:</label>
          <input type="text" id="${inputId}" placeholder="検索値を入力">
          <button id="${btnId}">検索</button>
        </div>
        <div class="count" id="${countId}"></div>
        <div class="table-wrap" id="${resultId}" style="margin-top:12px;"></div>
      `;
      container.appendChild(div);

      function doSearch() {
        const q = document.getElementById(inputId).value.trim();
        const resultEl = document.getElementById(resultId);
        const countEl = document.getElementById(countId);
        if (!q) { resultEl.innerHTML = ""; countEl.textContent = ""; return; }
        resultEl.innerHTML = "検索中...";
        countEl.textContent = "";
        fetch(`/api/search?sheet=${encodeURIComponent(sheet.name)}&q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              resultEl.innerHTML = `<span class="error">${data.error}</span>`;
              return;
            }
            countEl.textContent = `${data.count} 件見つかりました`;
            if (data.count === 0) { resultEl.innerHTML = ""; return; }
            let html = "<table><thead><tr><th>行</th>";
            data.headers.forEach(h => { html += `<th>${h.letter}: ${h.name}</th>`; });
            html += "</tr></thead><tbody>";
            data.rows.forEach(row => {
              html += `<tr><td>${row.row}</td>`;
              data.headers.forEach(h => {
                const v = row.data[h.letter];
                html += `<td>${v !== null ? v : ""}</td>`;
              });
              html += "</tr>";
            });
            html += "</tbody></table>";
            resultEl.innerHTML = html;
          })
          .catch(err => { resultEl.innerHTML = `<span class="error">通信エラー: ${err}</span>`; });
      }

      document.getElementById(btnId).addEventListener("click", doSearch);
      document.getElementById(inputId).addEventListener("keydown", e => { if (e.key === "Enter") doSearch(); });
    });
  });
</script>

</body>
</html>
